
<!DOCTYPE html>

<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WJTPXRD');
  </script>
<!-- End Google Tag Manager -->
<!-- Adding Analytics tag -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-7XLXLD52JM"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-7XLXLD52JM');
  </script>
<!-- end analytics-->
<!-- adding favicon link tags to the head -->
<link href="/images/favicons/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/images/favicons/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/images/favicons/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/images/favicons/site.webmanifest" rel="manifest"/>
<!--for some reason, the below breaks the code highlighting in codeblocks-->
<meta content="#da532c" name="msapplication-TileColor"/>
<meta content="#ffffff" name="theme-color"/>
<!-- end favicons -->
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="./theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="./theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="./theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="./theme/pygments/github.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="./theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="./theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="./theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<meta content="Freddie Larkins" name="author"/>
<meta content="Python is great for automating repetitive tasks, such as checking bin collection. I built a friendly Bin Bot to do just that." name="description"/>
<meta content="Requests, JSON" name="keywords"/>
<meta content="Freddie's SEO Blog ://" property="og:site_name">
<meta content="Building a bin collection reminder bot in Python" property="og:title"/>
<meta content="Python is great for automating repetitive tasks, such as checking bin collection. I built a friendly Bin Bot to do just that." property="og:description"/>
<meta content="en_GB" property="og:locale"/>
<meta content="./building-a-bin-collection-reminder-bot-in-python.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2022-04-01 09:31:00+01:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="./author/freddie-larkins.html" property="article:author"/>
<meta content="Python" property="article:section">
<meta content="Requests" property="article:tag"/>
<meta content="JSON" property="article:tag"/>
<meta content="./images/og/opengraph-default.png" property="og:image"/>
<title>Building a bin collection reminder bot in Python | Freddie's SEO Blog ://</title>
</meta></meta></meta></meta><link href="https://freddielarkins.xyz/building-a-bin-collection-reminder-bot-in-python.html" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Freddie's SEO Blog ://", "item": "https://freddielarkins.xyz"}, {"@type": "ListItem", "position": 2, "name": "Building a bin collection reminder bot in python", "item": "https://freddielarkins.xyz/building-a-bin-collection-reminder-bot-in-python.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Freddie Larkins"}, "publisher": {"@type": "Organization", "name": "Freddie's SEO Blog ://"}, "headline": "Building a bin collection reminder bot in Python", "about": "Python", "datePublished": "2022-04-01 09:31"}</script></head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript>
<iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-WJTPXRD" style="display:none;visibility:hidden" width="0"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->
<aside>
<div>
<a href="./">
<img alt="Freddie Larkins" src="/images/webp/freddie-larkins-mugshot.webp" title="Freddie Larkins"/>
</a>
<h1>
<a href="./">Freddie Larkins</a>
</h1>
<p>SEO, Python and other stuff.</p>
<nav>
<ul class="list">
<li>
<a href="/" target="_self">home</a>
</li>
<li>
<a href="/pdfs/freddie-larkins-cv.pdf" target="_self">cv</a>
</li>
<li>
<a href="/pages/about-me.html" target="_self">about me</a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://www.github.com/fredlarkins/" target="_blank">
<i class="fab fa-github"></i>
</a>
</li>
<li>
<a class="sc-linkedin" href="https://www.linkedin.com/in/freddielarkins/" target="_blank">
<i class="fab fa-linkedin"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<!-- Commenting out as I've got a home link in the side nav (top on desktop) -->
<!-- <a href="./">Home</a> -->
<a href="/archives.html">Archives</a>
<a href="/category/python.html">Python</a>
<a href="/category/seo.html">SEO</a>
</nav>
<article class="single">
<header>
<h1 id="building-a-bin-collection-reminder-bot-in-python">Building a bin collection reminder bot in Python</h1>
<p>
      Posted on Fri 01 April 2022 in <a href="./category/python.html">Python</a>
<!-- My addition - adding a different read-time plugin to the article template -->
<!-- -->

        â€¢ 6 min read
    </p>
</header>
<div>
<!--Status: draft-->
<p><strong>Sunday nights in our house involve a weekly ritual.</strong></p>
<p>First, we remember bins are due the following morning. Second, we realise we've forgotten what was collected the previous week. Third, we check the council's <a href="https://hackney-waste-pages.azurewebsites.net/">HackneyWaste bin-checker tool</a> to see what bins are due.</p>
<p>What if there was a better way?</p>
<p>Well, with Python, there is!</p>
<p>Using the <a href="https://docs.python-requests.org/en/latest/">Requests</a> library, we can mimic the series of http requests that your browser makes when using the HackneyWaste tool...</p>
<p><img alt="Gif showing the WasteChecker tool in DevTools" src="images/gifs/hackney-waste-portal.gif"/></p>
<p><center><em>Keep your eye on the DevTools panel on the left-hand side. Our precious requests!</em></center></p>
<p>...and we can get all the data you see rendered in your browser in JSON. We can use that data to send automatic reminders for what bins are being collected, alleviating the need to repeat the aforementioned ritual. Neat!</p>
<p>You can check out the repo below:</p>
<div class="github-card" data-github="fredlarkins/hackney-bin-bot" data-height="" data-theme="default" data-width=""></div>
<script src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
<p>I'll run through some of the interesting challenges I when building the bot.</p>
<hr/>
<div class="toc">
<ul>
<li><a href="#challenges">Challenges</a><ul>
<li><a href="#working-out-how-the-series-of-requests-fit-together">Working out how the series of requests fit together</a><ul>
<li><a href="#1-sending-a-postcode-choosing-address">1. Sending a postcode / choosing address</a></li>
<li><a href="#2-retrieving-the-bin-collection-services-for-the-address">2. Retrieving the bin collection services for the address</a></li>
<li><a href="#3-retrieving-the-collection-schedules-for-each-waste-service">3. Retrieving the collection schedules for each waste service</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#setting-up-a-cron-job-to-send-bin-collection-alerts">Setting up a Cron Job to send bin-collection alerts</a></li>
<li><a href="#learnings">Learnings</a><ul>
<li><a href="#1-use-a-text-comparison-tool-to-tease-out-which-bits-of-request-bodies-responses-are-important">1. Use a Text Comparison tool to tease out which bits of request bodies / responses are important.</a></li>
<li><a href="#2-throttle-devtools-to-slow-a-series-of-requests-down">2. Throttle DevTools to slow a series of requests down.</a></li>
<li><a href="#3-if-you-cant-work-it-out-step-away-and-do-something-else">3. If you can't work it out, step away and do something else.</a></li>
</ul>
</li>
</ul>
</div>
<hr/>
<h2 id="challenges">Challenges</h2>
<p>When I first started on this project, I actually set out to build something in Selenium. I'd load up the HackneyWaste tool the in a headless browser and use a mixture of <code>browser.find_element()</code> the <code>browser.send_keys()</code> to run through the same flow that a real user would:</p>
<ol>
<li>Input postcode</li>
<li>Hit Enter on <button>Search for your address</button></li>
<li>Select address from dropdown</li>
<li>Hit Enter on <button>Go</button></li>
<li>Scrape the resulting bin collection data using BeautifulSoup</li>
</ol>
<p>However, I didn't feel that would really teach me much about how the application worked. Nor would I gain any experience in scraping data from the backend - as it were - rather than the frontend.</p>
<p>So, I had to figure out how those series of requests led from this:</p>
<p><img alt="Screenshot of the first screen on the Waste Collection tool" src="/images/webp/waste-services-screenshot.webp"/></p>
<p>To this:</p>
<p><img alt="Screenshot of the final screen of the Waste Collection tool, showing collection dates" src="/images/webp/hackney-waste-final-screen.webp"/></p>
<h3 id="working-out-how-the-series-of-requests-fit-together">Working out how the series of requests fit together</h3>
<p>I've no shame in admitting it took me a while to get this right! </p>
<p>I figured it would make sense to run through the flow as a user would, seeing which requests pertain to each step in the flow.</p>
<h4 id="1-sending-a-postcode-choosing-address">1. Sending a postcode / choosing address</h4>
<p>The first couple of requests are <code>POST</code> requests to the first server, <code>18.169.89.254</code>. It receives the user's postcode and returns the street addresses for the user to select. </p>
<p><code>CTRL-F</code> was by best friend here: I could see that the postcode was buried deep in the request body. When testing this first step with other postcodes, I could see that nothing else changed in the lines and lines of JSON - just the postcode.</p>
<p>The response contains data for each of the addresses, such as street address and Basic Land and Property Unit class codes (I had to Google what those were - <em>tl;dr</em> they're not relevant for bin collections).</p>
<p>The <em>relevant</em> bit of information for each property is the <code>itemId</code>. This alphanumeric code uniquely identifies each property:</p>
<div class="highlight"><pre><span></span><code>itemId: "5f898d4790478c0067f8c316"
</code></pre></div>
<p>The user selects their address from the dropdown list; the application then uses that home's <code>itemId</code> in the next request to a second server, <code>3.10.72.124</code>, to query what bin collections apply to that property.</p>
<h4 id="2-retrieving-the-bin-collection-services-for-the-address">2. Retrieving the bin collection services for the address</h4>
<p>The next request is a <code>GET</code> request to server 2 (used for all subsequent requests), asking for the bin collection services applicable to that specific address. Not all addresses in Hackney have collections, and collection days vary by street. </p>
<p>The <code>itemID</code> we just obtained is used in the endpoint for this <code>GET</code> request:</p>
<pre><code>https://api.uk.alloyapp.io/api/item/<b>5f898d4790478c0067f8c318</b>?token=67ad2108-dd2b-407a-849a-411a15adf0b1</code></pre>
<p>There is one field in the JSON response that we're interested in: </p>
<div class="highlight"><pre><span></span><code>attributes_wasteContainersAssignableWasteContainers
</code></pre></div>
<p>This field contains a list of up to four new alphanumeric values, each of which represents a 'waste container' - i.e. recycling, food waste, black bins or garden waste. So far, the workflow looks a bit like this:</p>
<p><img alt="Diagram of the series of requests made between client and 2x servers" src="/images/webp/hackney_step_1.webp"/></p>
<p>For each value returned, the browser makes a request using the same scheme above (appending the <code>id</code> for the waste container to the endpoint) to map that value to a 'human-readable' service. So, for this property:</p>
<div class="highlight"><pre><span></span><code>5fa55c586b4fb500650caf08 ---&gt; Recycling Sack
5faea1a108c64000672a88fe ---&gt; Food Caddy (Small)
</code></pre></div>
<p>And so on.</p>
<h4 id="3-retrieving-the-collection-schedules-for-each-waste-service">3. Retrieving the collection schedules for each waste service</h4>
<p>This next bit is a bit confusing, and seems to me somewhat inefficient. Anyway.</p>
<p>The browser makes a <code>POST</code> request for each <code>id</code>  obtained above.</p>
<p>What we want in return is the value for:</p>
<div class="highlight"><pre><span></span><code>attributes_scheduleCodeWorkflowID_5f8dbfdce27d98006789b4ec
</code></pre></div>
<p>This gives us the <code>id</code> for the collection timetable, which we retrieve by hitting an endpoint <em>containing</em> that timetable <code>id</code> For instance:</p>
<div class="highlight"><pre><span></span><code>5fa55c586b4fb500650caf08    # the id for Recycling Sack
</code></pre></div>
<p>Gives us:</p>
<div class="highlight"><pre><span></span><code>workflows_testWorkflowRoundM1Mon_5f8dea39e27d98006789b99f   # the id for the recycling collection schedule
</code></pre></div>
<p>Incorporating the above <code>id</code> in the endpoint for our <code>GET</code> request gives us:</p>
<pre><code>https://api.uk.alloyapp.io/api/workflow/<b>workflows_testWorkflowRoundM1Mon_5f8dea39e27d98006789b99f</b>?token=67ad2108-dd2b-407a-849a-411a15adf0b1</code></pre>
<p>...which returns a JSON response with the timetable for that waste container:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s2">"workflow"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"workflow"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"Workflow_Round Mon"</span><span class="p">,</span>
            <span class="s2">"enabled"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s2">"trigger"</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">"dates"</span><span class="o">:</span> <span class="p">[</span>
                    <span class="s2">"2020-04-13T00:00:00.000Z"</span><span class="p">,</span> <span class="c1">// our timetable data</span>
                    <span class="s2">"2020-04-20T00:00:00.000Z"</span><span class="p">,</span>
                    <span class="s2">"2020-04-27T00:00:00.000Z"</span><span class="p">,</span>
                    <span class="p">...</span>
                    <span class="s2">"2024-01-01T01:01:00.000Z"</span>
                    <span class="p">],</span>
<span class="c1">// and lots of other superfluous json...     </span>
</code></pre></div>
<p>Rinse and repeat for each waste container  (recycling, food waste etc.) available for that address.</p>
<p>Represented visually, the flow looks like this:</p>
<p><img alt="Diagram showing the second series of client/server requests" src="/images/webp/hackney_bin_service_steps_2-3.webp"/></p>
<p>It seems like there are lots of unnecessary requests in this flow. But who knows; I'm not one to tell developers how to do their jobs!</p>
<p>Anyways, we've finally got what we want: the collection timetables for each waste service. But how to use that data to send alerts?</p>
<hr/>
<h2 id="setting-up-a-cron-job-to-send-bin-collection-alerts">Setting up a Cron Job to send bin-collection alerts</h2>
<p>I scratched my head about this one for a while as well.</p>
<p>I settled on the solution of running a daily script as a <a href="https://ostechnix.com/a-beginners-guide-to-cron-jobs/">Cron Job</a> - basically a scheduled command - that loops through each timetable, subtracting every date listed from the present date. If the difference equals 1, the collection is the following day:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection_is_due_tomorrow</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># looping through the timetable, getting the difference between today's date and the date in that iteration of the loop</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">timetable</span><span class="p">:</span>

        <span class="c1"># if it's the day before collection is due, this value will equal 1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># append the waste container to the 'collection_is_due_tomorrow' list</span>
            <span class="n">collection_is_due_tomorrow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waste_container</span><span class="p">)</span>
</code></pre></div>
<p>The script composes a simple email including what is due the following day, and sends it to the email addresses provided when running <code>check-bins.py</code> for the first time.</p>
<p>This is the email I received last Sunday:</p>
<p><img alt="Screenshot of the email that the Bin Bot sends" src="/images/webp/bin-bot-email.webp"/></p>
<p>And that's it! The Bin Bot's got us covered.</p>
<hr/>
<h2 id="learnings">Learnings</h2>
<p>I've done a bit of web scraping before, but this was the first time I tried to circumvent the front-end and go straight to the network requests to get the data I was after. So I'm definitely no expert. But I learned a fair bit from this exercise that'll hopefully serve me well in the future.</p>
<h3 id="1-use-a-text-comparison-tool-to-tease-out-which-bits-of-request-bodies-responses-are-important">1. Use a Text Comparison tool to tease out which bits of request bodies / responses are important.</h3>
<p>At first, I was slightly overwhelmed by the JSON I was sending and receiving. I couldn't work out which bits mattered, and which stayed the same no matter what address I was using. Text Compare tools could help me isolate the important variables.</p>
<p>Take these two identical looking <code>POST</code>-request bodies:</p>
<p><img alt="A text compare tool available online" src="/images/webp/text-compare.webp"/></p>
<p>Highlighted in blue, the only thing that is different between them is that very last value. From that, I know that bit of information is important, and likely explains why I get two different responses. You can use that approach with any two requests that look similar to zero in on the information that the server really needs.</p>
<h3 id="2-throttle-devtools-to-slow-a-series-of-requests-down">2. Throttle DevTools to slow a series of requests down.</h3>
<p>Part of this challenge was understanding how a series of up to fifteen requests fit together. Slowing them down helped me to get a sense of what request was governing the visual data I could see trickling through on the page:</p>
<p><img alt="Location of the 'throttle' feature in DevTools" src="/images/webp/devtools-throtttling.webp"/></p>
<h3 id="3-if-you-cant-work-it-out-step-away-and-do-something-else">3. If you can't work it out, step away and do something else.</h3>
<p>I spent hours trying figure out how this application worked. Often, though, I found that I made a breakthrough when I'd stepped away from my laptop for a few hours or days. It's a bit of a clichÃ©, but it really does help your brain reset and come at the project with a fresh set of eyes.</p>
<hr/>
<p><em>P.S. Hackney Council: if you're reading this, please don't change your backend. My Bin Bot won't like it ðŸ™ƒ</em></p>
</div>
<div class="tag-cloud">
<p>
<a href="./tag/requests.html">Requests</a>
<a href="./tag/json.html">JSON</a>
</p>
</div>
</article>
<footer>
<p>Â© Freddie Larkins April 2022 </p>
<p>
<!-- added a link to the xml sitemap in the footer -->
<a href="/sitemap.xml">Sitemap</a>
<span class="footer-separator">|</span>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="./theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p> </footer>
</main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Freddie's SEO Blog :// ",
  "url" : ".",
  "image": "/images/webp/freddie-larkins-mugshot.webp",
  "description": "Home of the ramblings of an SEO currently working for Zoopla."
}
</script>
</body>
</html>